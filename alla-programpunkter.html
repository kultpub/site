<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <title>Filtrera programpunkter (2010‚Äì2025)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg: #f8f8f8;
      --fg: #222;
      --muted:#666;
      --card:#ffffff;
      --border:#ddd;
      --accent:#0b66ff;
      --accent-2:#e8f0ff;
      --danger:#b00020;
      --chip:#eef2f7;
      --chip-fg:#223;
      --kbd:#f2f2f2;
      --kbd-b:#cfcfcf;
    }
    body.dark{
      --bg:#131416;
      --fg:#e8e8e8;
      --muted:#a9b0ba;
      --card:#1b1d21;
      --border:#2a2f36;
      --accent:#84a9ff;
      --accent-2:#1a2747;
      --danger:#ff8a8a;
      --chip:#232a34;
      --chip-fg:#dde5f1;
      --kbd:#20242a;
      --kbd-b:#3a424d;
    }

    html,body{height:100%}
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";
      margin:0; background:var(--bg); color:var(--fg);
    }
    .wrap{max-width:1600px; margin-inline:auto; padding:20px;}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px;}
    h1{font-size:clamp(18px,3vw,26px); margin:0; font-weight:700;}
    .muted{color:var(--muted)}
    .bar{
      background:var(--card); border:1px solid var(--border); border-radius:12px; padding:12px;
      display:grid; gap:10px; grid-template-columns: 1fr; margin-bottom:10px;
    }
    @media (min-width:920px){
      .bar{grid-template-columns: auto auto auto 1fr}
    }

    .group{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .group label{font-size:13px; color:var(--muted)}
    input[type="date"], button, .btn, .ms, .chip{
      border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--fg);
    }
    input[type="date"]{padding:6px 8px}
    button, .btn{
      padding:8px 10px; cursor:pointer; border:1px solid var(--border);
    }
    .btn-accent{background:var(--accent-2); border-color:var(--accent-2)}
    .btn-ghost{background:transparent}
    .btn:hover{filter:brightness(1.05)}
    .btn:focus-visible, input[type="date"]:focus-visible, .ms:focus-within{outline:2px solid var(--accent); outline-offset:2px}

    /* quick buttons row */
    .quick{display:flex; gap:6px; flex-wrap:wrap}

    /* Multi-select */
    .ms{min-width:260px; max-width:420px; padding:8px; position:relative}
    .ms .hdr{display:flex; align-items:center; gap:8px; margin-bottom:6px}
    .ms .hdr .title{font-size:13px; color:var(--muted)}
    .ms .search{width:100%; padding:6px 8px; border-radius:6px; border:1px solid var(--border); background:var(--bg); color:var(--fg)}
    .ms .list{max-height:220px; overflow:auto; margin-top:6px; border:1px dashed var(--border); border-radius:8px; padding:6px}
    .ms .row{display:flex; gap:8px; align-items:center; padding:4px 6px; border-radius:6px}
    .ms .row:hover{background:var(--bg)}
    .ms .actions{display:flex; gap:8px; margin-top:6px}
    .ms .empty{padding:8px; color:var(--muted); font-size:14px}

    /* chips */
    .chips{display:flex; gap:6px; flex-wrap:wrap; margin:10px 0}
    .chip{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; background:var(--chip); color:var(--chip-fg); border:0}
    .chip .x{cursor:pointer; font-weight:600}

    /* status row */
    .status{display:flex; align-items:center; gap:10px; justify-content:space-between; margin:6px 0 14px}
    .error{color:var(--danger); font-weight:600; display:none}
    .counter{font-weight:700}

    /* table */
    .table-wrap{overflow:auto; border:1px solid var(--border); border-radius:12px; background:var(--card)}
    table{border-collapse:separate; border-spacing:0; width:100%}
    th, td{padding:10px 12px; text-align:left; border-bottom:1px solid var(--border); white-space:nowrap}
    th{position:sticky; top:0; background:var(--card); z-index:1; font-size:13px; color:var(--muted)}
    tbody tr:hover{background:var(--bg)}
    .empty-row td{color:var(--muted); text-align:center}

    /* toolbar */
    .toolbar{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .spacer{flex:1}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
         font-size:12px; background:var(--kbd); color:var(--fg); padding:2px 6px; border-radius:6px; border:1px solid var(--kbd-b)}

    /* dark mode toggle */
    .toggle{display:inline-flex; align-items:center; gap:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Alla programpunkter 2010‚Äì2025</h1>
        <div class="muted">Filtrera p√• datum, kategori och plats. Allt uppdateras direkt.</div>
      </div>
      <div class="toggle">
        <span class="muted">Tema</span>
        <button id="theme" class="btn" aria-pressed="false" title="V√§xla m√∂rkt/ljusl√§ge">üåô/‚òÄÔ∏è</button>
      </div>
    </header>

    <section class="bar" aria-label="Filter">
      <div class="group" aria-label="Datumintervall">
        <label for="from">Fr√•n</label>
        <input id="from" type="date" min="2010-01-01" max="2025-12-31" />
        <label for="to">Till</label>
        <input id="to" type="date" min="2010-01-01" max="2025-12-31" />
      </div>

      <div class="group" aria-label="Snabbval">
        <span class="muted">Snabbval</span>
        <div class="quick">
          <button class="btn btn-ghost" data-range="today">Idag</button>
          <button class="btn btn-ghost" data-range="week">Denna vecka</button>
          <button class="btn btn-ghost" data-range="month">Denna m√•nad</button>
          <button class="btn btn-ghost" data-range="all">Alla √•r</button>
          <button class="btn btn-ghost" id="clear-dates">Rensa datum</button>
        </div>
      </div>

      <div class="ms" id="ms-category" aria-label="Kategorier" tabindex="0">
        <div class="hdr"><span class="title">Kategori(er)</span></div>
        <input class="search" placeholder="S√∂k i kategorier‚Ä¶" aria-label="S√∂k i kategorier" />
        <div class="list" role="listbox" aria-multiselectable="true"></div>
        <div class="actions">
          <button class="btn btn-accent" data-act="all">Alla</button>
          <button class="btn" data-act="clear">Rensa val</button>
        </div>
      </div>

      <div class="ms" id="ms-location" aria-label="Platser" tabindex="0">
        <div class="hdr"><span class="title">Plats/er</span></div>
        <input class="search" placeholder="S√∂k i platser‚Ä¶" aria-label="S√∂k i platser" />
        <div class="list" role="listbox" aria-multiselectable="true"></div>
        <div class="actions">
          <button class="btn btn-accent" data-act="all">Alla</button>
          <button class="btn" data-act="clear">Rensa val</button>
        </div>
      </div>
    </section>

    <div class="chips" id="chips"></div>

    <div class="status" aria-live="polite">
      <div class="toolbar">
        <button class="btn" id="reset">√Öterst√§ll alla filter</button>
        <div class="muted">Tips: anv√§nd <span class="kbd">Shift</span> + klick f√∂r att v√§lja/avmarkera snabbare i listorna.</div>
      </div>
      <div class="spacer"></div>
      <div class="error" id="err">‚ÄôTill‚Äô kan inte vara tidigare √§n ‚ÄôFr√•n‚Äô.</div>
      <div class="counter" id="count">‚Äî</div>
    </div>

    <div class="table-wrap" role="region" aria-label="Resultat">
      <table id="tbl">
        <thead>
          <tr>
            <th>Vad</th>
            <th>Datum</th>
            <th>Start</th>
            <th>Slut</th>
            <th>Varaktighet</th>
            <th>Kategori</th>
            <th>Plats</th>
            <th>Kommentar</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

  </div>

  <script>
    // ========= Utils =========
    const $ = (sel, root=document)=> root.querySelector(sel);
    const $$ = (sel, root=document)=> Array.from(root.querySelectorAll(sel));
    const fmtDate = (d)=> d.toISOString().slice(0,10);
    function weekBounds(now=new Date()){
      const day = (now.getDay()+6)%7; // 0=Mon
      const mon = new Date(now); mon.setDate(now.getDate()-day);
      const sun = new Date(mon); sun.setDate(mon.getDate()+6);
      return [mon, sun];
    }
    function debounce(fn, ms=160){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; }

    // Basic semicolon CSV parser with quotes support (RFC4180-ish)
    function parseCSV(text, delim=';'){
      const rows=[]; let row=[]; let field=''; let inQ=false;
      for(let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if(inQ){
          if(c === '"'){
            if(n === '"'){ field += '"'; i++; } else { inQ=false; }
          } else { field += c; }
        } else {
          if(c === '"'){ inQ=true; }
          else if(c === delim){ row.push(field); field=''; }
          else if(c === '\n'){ row.push(field); rows.push(row); row=[]; field=''; }
          else if(c === '\r'){ /* ignore */ }
          else { field += c; }
        }
      }
      if(field.length || row.length){ row.push(field); rows.push(row); }
      return rows;
    }

    // ========= State =========
    const STATE = {
      rows: [], // parsed objects
      categories: [],
      locations: [],
      selectedCats: new Set(),
      selectedLocs: new Set(),
    };

    const CIDX = { // column indices based on din CSV
      WHAT: 1,
      DATE: 3,        // YYYY-MM-DD
      START: 7,
      END: 8,
      DUR: 9,
      CAT: 10,
      LOC: 11,
      NOTE: 12
    };

    // ========= Theme =========
    const themeBtn = $('#theme');
    function applyTheme(t){
      document.body.classList.toggle('dark', t==='dark');
      themeBtn.setAttribute('aria-pressed', t==='dark' ? 'true' : 'false');
      localStorage.setItem('theme', t);
    }
    themeBtn.addEventListener('click', ()=>{
      const cur = document.body.classList.contains('dark') ? 'dark' : 'light';
      applyTheme(cur==='dark' ? 'light' : 'dark');
    });
    applyTheme(localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'));

    // ========= Multi-select factory =========
    function buildMultiSelect(rootEl, values, onChange){
      const search = $('.search', rootEl);
      const list = $('.list', rootEl);
      const actAll = $('[data-act="all"]', rootEl);
      const actClr = $('[data-act="clear"]', rootEl);
      const selected = new Set();

      function render(filter=''){
        list.innerHTML = '';
        const filtered = values
          .filter(v => v.toLowerCase().includes(filter.toLowerCase()));
        if(filtered.length === 0){
          const div = document.createElement('div');
          div.className='empty'; div.textContent='Inga tr√§ffar';
          list.appendChild(div);
          return;
        }
        for(const v of filtered){
          const row = document.createElement('label');
          row.className = 'row';
          row.innerHTML = `<input type="checkbox" /> <span>${v}</span>`;
          const cb = $('input', row);
          cb.checked = selected.has(v);
          cb.addEventListener('change', ()=>{
            cb.checked ? selected.add(v) : selected.delete(v);
            onChange(new Set(selected));
          });
          // shift-click range select (optional nicety)
          row.addEventListener('click', (e)=>{
            if(e.shiftKey){ cb.checked = !cb.checked; cb.dispatchEvent(new Event('change')); }
          });
          list.appendChild(row);
        }
      }
      search.addEventListener('input', debounce(()=> render(search.value), 120));
      actAll.addEventListener('click', ()=>{ selected.clear(); onChange(new Set(selected)); render(search.value); });
      actClr.addEventListener('click', ()=>{ selected.clear(); onChange(new Set(selected)); render(search.value); });

      render();
      return {
        set(valuesNew){
          // rebuild with new values while keeping selection if possible
          const kept = new Set([...selected].filter(v => valuesNew.includes(v)));
          selected.clear(); kept.forEach(v=>selected.add(v));
          values = valuesNew.slice();
          render(search.value || '');
        },
        getSelected(){ return new Set(selected); },
        setSelected(setVals){
          selected.clear(); setVals.forEach(v=>selected.add(v));
          render(search.value || '');
        }
      };
    }

    // ========= Chips =========
    function renderChips(){
      const cont = $('#chips'); cont.innerHTML = '';
      const make = (label, val, type) => {
        const chip = document.createElement('span'); chip.className='chip';
        chip.innerHTML = `<span>${label}: ${val}</span> <span class="x" role="button" title="Ta bort">‚úï</span>`;
        $('.x', chip).addEventListener('click', ()=>{
          if(type==='cat'){ STATE.selectedCats.delete(val); msCat.setSelected(STATE.selectedCats); }
          if(type==='loc'){ STATE.selectedLocs.delete(val); msLoc.setSelected(STATE.selectedLocs); }
          runFilter();
        });
        return chip;
      };
      [...STATE.selectedCats].forEach(v=> cont.appendChild(make('Kategori', v, 'cat')));
      [...STATE.selectedLocs].forEach(v=> cont.appendChild(make('Plats', v, 'loc')));

      const from = $('#from').value, to = $('#to').value;
      if(from) cont.appendChild(make('Fr√•n', from, 'from')).querySelector('.x').onclick = ()=>{ $('#from').value=''; runFilter(); };
      if(to)   cont.appendChild(make('Till', to, 'to')).querySelector('.x').onclick   = ()=>{ $('#to').value=''; runFilter(); };
    }

    // ========= Filtering =========
    const errEl = $('#err');
    const countEl = $('#count');
    const tbody = $('#tbl tbody');

    function validateDates(){
      errEl.style.display = 'none';
      const f = $('#from').value, t = $('#to').value;
      if(f && t && new Date(f) > new Date(t)){
        errEl.style.display = 'block'; return false;
      }
      return true;
    }

    function rowMatches(r, fDate, tDate){
      // date check
      if(fDate && r._date < fDate) return false;
      if(tDate && r._date > tDate) return false;
      // category OR logic within cats
      if(STATE.selectedCats.size>0 && !STATE.selectedCats.has(r.category)) return false;
      // location OR logic within locs
      if(STATE.selectedLocs.size>0 && !STATE.selectedLocs.has(r.location)) return false;
      return true;
    }

    function renderRows(rows){
      tbody.innerHTML='';
      if(rows.length === 0){
        const tr = document.createElement('tr'); tr.className='empty-row';
        const td = document.createElement('td'); td.colSpan=8; td.textContent='Inga tr√§ffar ‚Äì justera filter.';
        tr.appendChild(td); tbody.appendChild(tr); return;
      }
      const frag = document.createDocumentFragment();
      for(const r of rows){
        const tr = document.createElement('tr');
        [r.what, r.date, r.start, r.end, r.duration, r.category, r.location, r.note]
          .forEach(v => { const td=document.createElement('td'); td.textContent = (v||'').trim(); tr.appendChild(td); });
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);
    }

    function saveFiltersToURLAndStorage(){
      const params = new URLSearchParams();
      if($('#from').value) params.set('from', $('#from').value);
      if($('#to').value)   params.set('to', $('#to').value);
      if(STATE.selectedCats.size) params.set('cat', [...STATE.selectedCats].join('|'));
      if(STATE.selectedLocs.size) params.set('loc', [...STATE.selectedLocs].join('|'));
      history.replaceState(null,'', `${location.pathname}?${params.toString()}`);
      localStorage.setItem('progFilters', JSON.stringify({
        from: $('#from').value || '',
        to: $('#to').value || '',
        cats: [...STATE.selectedCats],
        locs: [...STATE.selectedLocs]
      }));
    }

    function restoreFiltersFromURLOrStorage(){
      const params = new URLSearchParams(location.search);
      const saved = localStorage.getItem('progFilters');
      let data = { from:'', to:'', cats:[], locs:[] };

      if(params.has('from') || params.has('to') || params.has('cat') || params.has('loc')){
        data.from = params.get('from') || '';
        data.to   = params.get('to') || '';
        data.cats = (params.get('cat') || '').split('|').filter(Boolean);
        data.locs = (params.get('loc') || '').split('|').filter(Boolean);
      } else if(saved){
        try{ data = JSON.parse(saved) } catch{}
      }
      if(data.from) $('#from').value = data.from;
      if(data.to)   $('#to').value   = data.to;
      STATE.selectedCats = new Set(data.cats||[]);
      STATE.selectedLocs = new Set(data.locs||[]);
    }

    function runFilter(){
      if(!validateDates()){ renderRows([]); countEl.textContent = '0 tr√§ffar'; return; }
      const f = $('#from').value ? new Date($('#from').value) : null;
      const t = $('#to').value ? new Date($('#to').value) : null;

      // update chips and persist
      renderChips();
      saveFiltersToURLAndStorage();

      const out = STATE.rows.filter(r => rowMatches(r, f, t));
      renderRows(out);
      countEl.textContent = `${out.length} tr√§ffar`;
    }

    // ========= Build UI once data is loaded =========
    let msCat, msLoc;

    function hydrateMultiSelects(){
      // build unique sorted sets
      STATE.categories = Array.from(new Set(STATE.rows.map(r=>r.category).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'sv'));
      STATE.locations  = Array.from(new Set(STATE.rows.map(r=>r.location).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'sv'));

      // build controls
      msCat = buildMultiSelect($('#ms-category'), STATE.categories, (sel)=>{ STATE.selectedCats = sel; runFilter(); });
      msLoc = buildMultiSelect($('#ms-location'), STATE.locations,  (sel)=>{ STATE.selectedLocs = sel; runFilter(); });

      // apply restored selections
      msCat.setSelected(STATE.selectedCats);
      msLoc.setSelected(STATE.selectedLocs);
    }

    // ========= CSV load =========
    const CSV_PATH = 'alla-programpunkter.csv'; // l√§gg filen bredvid denna HTML
    async function loadCSV(){
      const res = await fetch(CSV_PATH);
      const text = await res.text();

      const rows = parseCSV(text, ';');
      if(rows.length === 0) return;
      // antar att f√∂rsta raden √§r header
      const dataRows = rows.slice(1).filter(r => r && r.length > Math.max(...Object.values(CIDX)) && r.join('').trim() !== '');

      STATE.rows = dataRows.map(cols => {
        const dateStr = (cols[CIDX.DATE]||'').trim();
        let d; try{ d = new Date(dateStr); }catch{ d=null; }
        return {
          what: (cols[CIDX.WHAT]||'').trim(),
          date: dateStr,
          _date: d,
          start: (cols[CIDX.START]||'').trim(),
          end: (cols[CIDX.END]||'').trim(),
          duration: (cols[CIDX.DUR]||'').trim(),
          category: (cols[CIDX.CAT]||'').trim(),
          location: (cols[CIDX.LOC]||'').trim(),
          note: (cols[CIDX.NOTE]||'').trim(),
        };
      }).filter(r => r.date && r._date && !Number.isNaN(r._date.getTime()));

      hydrateMultiSelects();
      // initial render using restored filters
      runFilter();
    }

    // ========= Hook up controls =========
    $('#from').addEventListener('change', runFilter);
    $('#to').addEventListener('change', runFilter);

    // quick range buttons
    $$('.quick [data-range]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const now = new Date();
        if(btn.dataset.range === 'today'){
          $('#from').value = fmtDate(now);
          $('#to').value = fmtDate(now);
        } else if(btn.dataset.range === 'week'){
          const [mon, sun] = weekBounds(now);
          $('#from').value = fmtDate(mon);
          $('#to').value = fmtDate(sun);
        } else if(btn.dataset.range === 'month'){
          const y = now.getFullYear(), m = now.getMonth();
          const first = new Date(y, m, 1);
          const last  = new Date(y, m+1, 0);
          $('#from').value = fmtDate(first);
          $('#to').value   = fmtDate(last);
        } else if(btn.dataset.range === 'all'){
          $('#from').value = '2010-01-01';
          $('#to').value   = '2025-12-31';
        }
        runFilter();
      });
    });
    $('#clear-dates').addEventListener('click', ()=>{ $('#from').value=''; $('#to').value=''; runFilter(); });

    $('#reset').addEventListener('click', ()=>{
      $('#from').value=''; $('#to').value='';
      STATE.selectedCats.clear(); STATE.selectedLocs.clear();
      msCat.setSelected(STATE.selectedCats);
      msLoc.setSelected(STATE.selectedLocs);
      history.replaceState(null,'', location.pathname);
      localStorage.removeItem('progFilters');
      runFilter();
    });

    // ========= Boot =========
    // 1) restore filters before data, so chips render properly later
    restoreFiltersFromURLOrStorage();
    // 2) load data
    loadCSV();
  </script>
</body>
</html>
