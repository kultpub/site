<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Utställningsplan – GANTT</title>
<style>
/* === Layout och färger === */
html,body{margin:0;font-family:"Segoe UI",sans-serif;background:#f8f9fa;height:auto;overflow:auto}
header{display:flex;justify-content:space-between;align-items:center;background:#005ea5;color:#fff;padding:10px 20px}
header h1{margin:0;font-size:1.2em}
header select{padding:6px 10px;border:none;border-radius:6px;cursor:pointer}
header button{background:#2ecc71;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:0.9em;cursor:pointer}
header button:hover{background:#27ae60}
#timeline-wrapper{flex:1;overflow:auto;border:1px solid #ccc;border-radius:6px;background:#fff;position:relative}
#timeline-wrapper::-webkit-scrollbar{height:10px}
#timeline-wrapper::-webkit-scrollbar-thumb{background:#bbb;border-radius:5px}
.month-label{position:absolute;top:0;height:24px;text-align:center;font-size:0.8em;color:#444;border-left:1px solid #eee;background:#f9f9f9}
.exhibition{position:absolute;height:12px;border-radius:4px;cursor:pointer}
.name-label{position:absolute;top:-24px;font-size:1em;font-weight:600;letter-spacing:0.3px}
.date-row{position:absolute;top:14px;font-size:0.8em;width:100%;display:flex;justify-content:space-between;color:#333}
.location-label{position:absolute;left:-200px;width:180px;text-align:right;font-weight:600;font-size:0.9em;color:#444;writing-mode:vertical-rl;transform:rotate(180deg)}
/* === Modal === */
.modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);justify-content:center;align-items:center;z-index:50}
.modal{background:#fff;border-radius:8px;padding:20px;min-width:320px;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,0.4);animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.modal h2{margin-top:0;margin-bottom:10px}
.modal label{display:block;margin-top:8px;font-size:0.9em}
.modal input[type="text"],.modal input[type="date"],.modal input[type="color"]{width:100%;padding:6px;margin-top:2px;box-sizing:border-box}
.modal-buttons{display:flex;justify-content:space-between;margin-top:15px}
.modal button{padding:8px 14px;border:none;border-radius:6px;cursor:pointer}
.save-btn{background:#005ea5;color:#fff}
.delete-btn{background:#dc3545;color:#fff}
.cancel-btn{background:#ccc;color:#000}
.date-row-inline{display:flex;align-items:center;justify-content:space-between;gap:8px}
.date-row-inline label{margin-top:0;font-size:0.9em;flex:1}
.date-row-inline input[type="date"]{flex:1}
.date-row-inline .approx{flex:none;white-space:nowrap;display:flex;align-items:center;gap:4px}
/* === Scrollkula === */
#customScrollContainer{width:100%;height:40px;display:flex;justify-content:center;align-items:center;background:#f8f9fa}
#scrollTrack{position:relative;width:80%;height:4px;background:#ddd;border-radius:2px}
#scrollThumb{position:absolute;top:50%;transform:translateY(-50%);width:22px;height:22px;background:#007acc;border-radius:50%;cursor:pointer;transition:all 0.2s ease;box-shadow:0 2px 6px rgba(0,0,0,0.25)}
#scrollThumb:hover{background:#005ea5;transform:translateY(-50%) scale(1.15);box-shadow:0 3px 8px rgba(0,0,0,0.35)}
</style>
</head>
<body>

<header>
  <h1>Utställningsplan</h1>
  <div>
    <strong>Välj år:</strong>
    <select id="yearSelect" onchange="changeYear()">
      <option value="2024">2024</option>
      <option value="2025" selected>2025</option>
      <option value="2026">2026</option>
      <option value="2027">2027</option>
    </select>
    <button onclick="openModal()">+ Lägg till utställning</button>
  </div>
</header>

<div id="customScrollContainer">
  <div id="scrollTrack"><div id="scrollThumb"></div></div>
</div>

<div id="container">
  <div id="timeline-wrapper"><div id="timeline"></div></div>
</div>

<!-- Modal -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h2 id="modalTitle">Ny utställning</h2>
    <input type="hidden" id="editId">
    <label>Titel:</label><input type="text" id="name">
    <label>Lokal:</label><input type="text" id="location"><br>
<div class="date-row-inline">
  <label>Startdatum:</label><input type="date" id="start">
  <label class="approx"><input type="checkbox" id="approxStart"> Ungefärlig start</label>
</div>
<div class="date-row-inline">
  <label>Slutdatum:</label><input type="date" id="end">
  <label class="approx"><input type="checkbox" id="approxEnd"> Ungefärligt slut</label>
</div>
<label>Färg:</label><input type="color" id="color" value="#007acc"><br>
<div class="modal-buttons">
  <button class="save-btn" onclick="saveExhibition()">Spara</button>
  <button class="delete-btn" id="deleteBtn" onclick="deleteExhibition()">Ta bort</button>
  <button class="cancel-btn" onclick="closeModal()">Avbryt</button>
</div>
  </div>
</div>

<script>
/* === Datakälla === */
const CSV_URL = "https://corsproxy.io/?https://docs.google.com/spreadsheets/d/e/2PACX-1vRXja3OdkrExI_xKLMdDmR6Bb_7iUKM3w_SJso8txgSLjqTGY0q-LhWTDnp3fo3kNXrYJHllsdd9gOS/pub?gid=0&single=true&output=csv";

let shouldCenter = true;
let exhibitions = [];
const totalMonths = 36;
const dayWidth = 3.5;
let baseYear = 2025;

/* === Hämta från Google Sheet === */
async function loadFromCSV() {
  try {
    const res = await fetch(CSV_URL + "&t=" + Date.now());
    if (!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();

    console.log("=== Hämtad CSV ===");
    console.log(text.substring(0, 300)); // visar början i konsolen

    // Dela upp korrekt (även med citattecken)
    const rows = text.trim().split(/\r?\n/).map(r =>
      r.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g)?.map(c => c.replace(/^"|"$/g, "").trim()) || []
    );

    const headers = rows.shift();
    console.log("Headers:", headers);

    exhibitions = rows.map(row => {
      const obj = {};
      headers.forEach((h, i) => (obj[h] = row[i] || ""));
      return {
        id: Math.random().toString(36).slice(2),
        name: obj["Rubrik"],
        location: obj["Lokal"],
        start: obj["Startdatum"],
        end: obj["Slutdatum"],
        approxStart: obj["UngefärligStart"].toLowerCase() === "true",
        approxEnd: obj["UngefärligtSlut"].toLowerCase() === "true",
        color: obj["Färg"] || "#007acc"
      };
    });

    console.log("✅ Parsed exhibitions:", exhibitions);
    drawTimeline(true);
  } catch (err) {
    console.error("❌ Fel vid hämtning/tolkning av CSV:", err);
  }
}



/* === Modalhantering === */
function openModal(id=null){
  const bg=document.getElementById("modalBg");bg.style.display="flex";
  const del=document.getElementById("deleteBtn");
  if(id){
    const ex=exhibitions.find(e=>e.id===id);
    document.getElementById("modalTitle").textContent="Redigera utställning";
    document.getElementById("editId").value=ex.id;
    document.getElementById("name").value=ex.name;
    document.getElementById("location").value=ex.location;
    document.getElementById("start").value=ex.start;
    document.getElementById("end").value=ex.end;
    document.getElementById("color").value=ex.color;
    document.getElementById("approxStart").checked=ex.approxStart;
    document.getElementById("approxEnd").checked=ex.approxEnd;
    del.style.display="inline-block";
  }else{
    document.getElementById("modalTitle").textContent="Ny utställning";
    document.querySelectorAll("#modalBg input").forEach(i=>i.value="");
    document.getElementById("color").value="#007acc";
    document.getElementById("approxStart").checked=false;
    document.getElementById("approxEnd").checked=false;
    del.style.display="none";
  }
}
function closeModal(){document.getElementById("modalBg").style.display="none";}

/* === Lokala ändringar (endast visuella) === */
function saveExhibition(){
  const id=document.getElementById("editId").value||Date.now().toString();
  const d={
    id,
    name:document.getElementById("name").value.trim(),
    location:document.getElementById("location").value.trim(),
    start:document.getElementById("start").value,
    end:document.getElementById("end").value,
    color:document.getElementById("color").value,
    approxStart:document.getElementById("approxStart").checked,
    approxEnd:document.getElementById("approxEnd").checked
  };
  const i=exhibitions.findIndex(e=>e.id===id);
  if(i>=0)exhibitions[i]=d; else exhibitions.push(d);
  drawTimeline();closeModal();
}
function deleteExhibition(){
  const id=document.getElementById("editId").value;
  exhibitions=exhibitions.filter(e=>e.id!==id);
  drawTimeline();closeModal();
}

/* === Ritlogik === */
function changeYear(){baseYear=parseInt(document.getElementById("yearSelect").value);shouldCenter=true;drawTimeline();}
function drawTimeline(){
  const timeline=document.getElementById("timeline");timeline.innerHTML="";
  const startAxis=new Date(baseYear-1,0,1);
  const monthNames=["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];
  for(let i=0;i<totalMonths;i++){
    const d=new Date(startAxis.getFullYear(),startAxis.getMonth()+i,1);
    const lbl=document.createElement("div");
    lbl.className="month-label";
    lbl.style.left=((d-startAxis)/86400000*dayWidth)+"px";
    lbl.textContent=monthNames[d.getMonth()]+(d.getMonth()===0?" "+d.getFullYear():"");
    timeline.appendChild(lbl);
  }
  const grouped={};
  for(const ex of exhibitions){if(!grouped[ex.location])grouped[ex.location]=[];grouped[ex.location].push(ex);}
  let locIndex=0;
  for(const loc in grouped){
    const g=grouped[loc];g.sort((a,b)=>new Date(a.start)-new Date(b.start));
    const locLabel=document.createElement("div");
    locLabel.className="location-label";locLabel.style.top=(100+locIndex*90)+"px";locLabel.textContent=loc;
    timeline.appendChild(locLabel);
    g.forEach(ex=>{
      const s=new Date(ex.start),e=new Date(ex.end);
      const startRef=new Date(baseYear-1,0,1);
      const left=(s-startRef)/86400000*dayWidth;
      const width=(e-s)/86400000*dayWidth;
      const rowY=70+locIndex*90;
      const div=document.createElement("div");
      div.className="exhibition";div.style.left=left+"px";div.style.top=rowY+"px";
      div.style.width=width+"px";div.style.background=ex.color;div.onclick=()=>openModal(ex.id);
      const name=document.createElement("div");name.className="name-label";name.textContent=ex.name;div.appendChild(name);
      const dates=document.createElement("div");dates.className="date-row";
      const ey=e.getFullYear();const same=ey===s.getFullYear();
      dates.innerHTML=`<span>${formatDateShort(s,false)}</span><span>${formatDateShort(e,!same)}</span>`;
      div.appendChild(dates);
      timeline.appendChild(div);
    });
    locIndex++;
  }
  initCustomScroll();
}
function formatDateShort(d,includeY){const m=["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];return d.getDate()+" "+m[d.getMonth()]+(includeY?" "+d.getFullYear():"");}

/* === Scroll === */
function initCustomScroll(){
  const wrap=document.getElementById("timeline-wrapper"),thumb=document.getElementById("scrollThumb"),track=document.getElementById("scrollTrack");
  function update(){const ratio=wrap.scrollLeft/(wrap.scrollWidth-wrap.clientWidth);const max=track.clientWidth-thumb.offsetWidth;thumb.style.left=ratio*max+"px";}
  wrap.addEventListener("scroll",update);update();
  let drag=false,startX=0,startL=0;
  thumb.addEventListener("mousedown",e=>{drag=true;startX=e.clientX;startL=parseFloat(thumb.style.left)||0;document.body.style.userSelect="none";});
  window.addEventListener("mousemove",e=>{if(!drag)return;const dx=e.clientX-startX;const max=track.clientWidth-thumb.offsetWidth;
    const newL=Math.min(Math.max(startL+dx,0),max);thumb.style.left=newL+"px";
    const ratio=newL/max;wrap.scrollLeft=ratio*(wrap.scrollWidth-wrap.clientWidth);});
  window.addEventListener("mouseup",()=>{if(drag){drag=false;document.body.style.userSelect="";}});
}

window.onload=loadFromCSV;
</script>
</body>
</html>


