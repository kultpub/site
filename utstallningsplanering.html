<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Utställningsplan – GANTT</title>
<style>
/* === Layout och färger === */
html,body{margin:0;font-family:"Segoe UI",sans-serif;background:#f8f9fa;height:auto;overflow:auto}
header{display:flex;justify-content:space-between;align-items:center;background:#005ea5;color:#fff;padding:10px 20px}
header h1{margin:0;font-size:1.2em}
header select{padding:6px 10px;border:none;border-radius:6px;cursor:pointer}
header button{background:#2ecc71;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:0.9em;cursor:pointer}
header button:hover{background:#27ae60}
#timeline-wrapper{flex:1;overflow:auto;border:1px solid #ccc;border-radius:6px;background:#fff;position:relative}
#timeline-wrapper::-webkit-scrollbar{height:10px}
#timeline-wrapper::-webkit-scrollbar-thumb{background:#bbb;border-radius:5px}
.month-label{position:absolute;top:0;height:24px;text-align:center;font-size:0.8em;color:#444;border-left:1px solid #eee;background:#f9f9f9}
.exhibition{position:absolute;height:12px;border-radius:4px;cursor:pointer}
.name-label{position:absolute;top:-24px;font-size:1em;font-weight:600;letter-spacing:0.3px}
.date-row{position:absolute;top:14px;font-size:0.8em;width:100%;display:flex;justify-content:space-between;color:#333}
.location-label{position:absolute;left:-200px;width:180px;text-align:right;font-weight:600;font-size:0.9em;color:#444;writing-mode:vertical-rl;transform:rotate(180deg)}
/* === Modal === */
.modal-bg{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);justify-content:center;align-items:center;z-index:50}
.modal{background:#fff;border-radius:8px;padding:20px;min-width:320px;max-width:400px;box-shadow:0 4px 12px rgba(0,0,0,0.4);animation:fadeIn .25s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
.modal h2{margin-top:0;margin-bottom:10px}
.modal label{display:block;margin-top:8px;font-size:0.9em}
.modal input[type="text"],.modal input[type="date"],.modal input[type="color"]{width:100%;padding:6px;margin-top:2px;box-sizing:border-box}
.modal-buttons{display:flex;justify-content:space-between;margin-top:15px}
.modal button{padding:8px 14px;border:none;border-radius:6px;cursor:pointer}
.save-btn{background:#005ea5;color:#fff}
.delete-btn{background:#dc3545;color:#fff}
.cancel-btn{background:#ccc;color:#000}
.date-row-inline{display:flex;align-items:center;justify-content:space-between;gap:8px}
.date-row-inline label{margin-top:0;font-size:0.9em;flex:1}
.date-row-inline input[type="date"]{flex:1}
.date-row-inline .approx{flex:none;white-space:nowrap;display:flex;align-items:center;gap:4px}
/* === Scrollkula === */
#customScrollContainer{width:100%;height:40px;display:flex;justify-content:center;align-items:center;background:#f8f9fa}
#scrollTrack{position:relative;width:80%;height:4px;background:#ddd;border-radius:2px}
#scrollThumb{position:absolute;top:50%;transform:translateY(-50%);width:22px;height:22px;background:#007acc;border-radius:50%;cursor:pointer;transition:all 0.2s ease;box-shadow:0 2px 6px rgba(0,0,0,0.25)}
#scrollThumb:hover{background:#005ea5;transform:translateY(-50%) scale(1.15);box-shadow:0 3px 8px rgba(0,0,0,0.35)}
</style>
</head>
<body>

<header>
  <h1>Utställningsplan</h1>
  <div>
    <strong>Välj år:</strong>
    <select id="yearSelect" onchange="changeYear()">
      <option value="2024">2024</option>
      <option value="2025" selected>2025</option>
      <option value="2026">2026</option>
      <option value="2027">2027</option>
    </select>
    <button onclick="openModal()">+ Lägg till utställning</button>
  </div>
</header>

<div id="customScrollContainer">
  <div id="scrollTrack"><div id="scrollThumb"></div></div>
</div>

<div id="container">
  <div id="timeline-wrapper"><div id="timeline"></div></div>
</div>

<!-- Modal -->
<div class="modal-bg" id="modalBg">
  <div class="modal">
    <h2 id="modalTitle">Ny utställning</h2>
    <input type="hidden" id="editId">
    <label>Titel:</label><input type="text" id="name">
    <label>Lokal:</label><input type="text" id="location"><br>
<div class="date-row-inline">
  <label>Startdatum:</label><input type="date" id="start">
  <label class="approx"><input type="checkbox" id="approxStart"> Ungefärlig start</label>
</div>
<div class="date-row-inline">
  <label>Slutdatum:</label><input type="date" id="end">
  <label class="approx"><input type="checkbox" id="approxEnd"> Ungefärligt slut</label>
</div>
<label>Färg:</label><input type="color" id="color" value="#007acc"><br>
<div class="modal-buttons">
  <button class="save-btn" onclick="saveExhibition()">Spara</button>
  <button class="delete-btn" id="deleteBtn" onclick="deleteExhibition()">Ta bort</button>
  <button class="cancel-btn" onclick="closeModal()">Avbryt</button>
</div>
  </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbzM9Kh5pOCnpvRUIJtIHI0DPg0qqZVXOPp6r3PhBh_PoRGNkQfUKHh1Zqsq50heiahLzw/exec";

let shouldCenter = true;
let exhibitions = [];
const totalMonths = 36;
const dayWidth = 3.5;
let baseYear = 2025;

/* === Hämta från Google Apps Script === */
async function loadFromSheet() {
  try {
    const res = await fetch(API);
    const json = await res.json();

    if (json.role === "none") {
      alert("Inloggning krävs eller ingen behörighet.");
      return;
    }

    const headers = json.data[0];
    const rows = json.data.slice(1);

    exhibitions = rows.map(row => {
      const obj = {};
      headers.forEach((h, i) => (obj[h] = row[i] || ""));
      return {
        id: Math.random().toString(36).slice(2),
        name: obj["Rubrik"],
        location: obj["Lokal"],
        start: obj["Startdatum"],
        end: obj["Slutdatum"],
        color: obj["Färg"] || "#007acc",
        approxStart: obj["UngefärligStart"] === "TRUE",
        approxEnd: obj["UngefärligtSlut"] === "TRUE"
      };
    });

    console.log("✅ Data hämtad från Apps Script:", exhibitions.length, "poster");
    drawTimeline(true);

    // visa / dölj knappen beroende på roll
    document.querySelector("button[onclick='openModal()']").style.display =
      json.role === "edit" ? "inline-block" : "none";

  } catch (err) {
    console.error("❌ Fel vid hämtning:", err);
    exhibitions = [];
    drawTimeline(true);
  }
}

/* === Skriv till Google Apps Script === */
async function saveToSheet() {
  try {
    const obj = {
      Rubrik: document.getElementById("name").value.trim(),
      Lokal: document.getElementById("location").value.trim(),
      Startdatum: document.getElementById("start").value,
      UngefärligStart: document.getElementById("approxStart").checked ? "TRUE" : "",
      Slutdatum: document.getElementById("end").value,
      UngefärligtSlut: document.getElementById("approxEnd").checked ? "TRUE" : "",
      Färg: document.getElementById("color").value
    };

    const res = await fetch(API, { method: "POST", body: JSON.stringify(obj) });
    const text = await res.text();
    console.log("Svar från POST:", text);

    if (text.trim() === "OK") {
      await loadFromSheet();
      closeModal();
    } else {
      alert(text);
    }
  } catch (err) {
    console.error("❌ Fel vid sparning:", err);
  }
}

/* === Hjälpfunktioner och ritlogik === */
function monthsBetween(a, b) {
  const months = (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth());
  const daysInMonth = new Date(b.getFullYear(), b.getMonth() + 1, 0).getDate();
  const fraction = (b.getDate() - 1) / daysInMonth;
  return months + fraction;
}

function changeYear() {
  baseYear = parseInt(document.getElementById("yearSelect").value);
  shouldCenter = true;
  drawTimeline();
}

function openModal(exId = null) {
  document.getElementById("modalBg").style.display = "flex";
  const delBtn = document.getElementById("deleteBtn");
  if (exId) {
    const ex = exhibitions.find(e => e.id === exId);
    if (!ex) return;
    document.getElementById("modalTitle").textContent = "Redigera utställning";
    document.getElementById("editId").value = ex.id;
    document.getElementById("name").value = ex.name;
    document.getElementById("location").value = ex.location || "";
    document.getElementById("start").value = ex.start;
    document.getElementById("end").value = ex.end;
    document.getElementById("color").value = ex.color;
    document.getElementById("approxStart").checked = ex.approxStart;
    document.getElementById("approxEnd").checked = ex.approxEnd;
    delBtn.style.display = "inline-block";
  } else {
    document.getElementById("modalTitle").textContent = "Ny utställning";
    document.getElementById("editId").value = "";
    document.getElementById("name").value = "";
    document.getElementById("location").value = "";
    document.getElementById("start").value = "";
    document.getElementById("end").value = "";
    document.getElementById("color").value = getRandomColor();
    document.getElementById("approxStart").checked = false;
    document.getElementById("approxEnd").checked = false;
    delBtn.style.display = "none";
  }
}

function closeModal() {
  document.getElementById("modalBg").style.display = "none";
}

function getRandomColor() {
  const palette = [
    "#007acc", "#28a745", "#dc3545", "#ffc107", "#17a2b8",
    "#9c27b0", "#e67e22", "#20c997", "#6f42c1", "#fd7e14"
  ];
  return palette[Math.floor(Math.random() * palette.length)];
}

function saveExhibition() {
  if (!document.getElementById("name").value.trim() ||
      !document.getElementById("start").value ||
      !document.getElementById("end").value) {
    alert("Fyll i minst titel och datum.");
    return;
  }
  saveToSheet();
}

function deleteExhibition() {
  alert("Borttagning stöds ännu inte i detta gränssnitt."); // kan byggas senare
  closeModal();
}

/* === Ritning av tidslinjen (oförändrad) === */
function drawTimeline(center = false) {
  const timeline = document.getElementById("timeline");
  timeline.innerHTML = "";

  const startAxis = new Date(baseYear - 1, 0, 1);
  const monthNames = ["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];

  for (let i = 0; i < totalMonths; i++) {
    const d = new Date(startAxis.getFullYear(), startAxis.getMonth() + i, 1);
    const lbl = document.createElement("div");
    lbl.className = "month-label";
    const daysInMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
    lbl.style.left = ((d - startAxis) / 86400000 * dayWidth) + "px";
    lbl.style.width = (daysInMonth * dayWidth) + "px";
    const text = monthNames[d.getMonth()] + (d.getMonth() === 0 ? " " + d.getFullYear() : "");
    lbl.textContent = text;
    timeline.appendChild(lbl);

    if (d.getMonth() === 0) {
      const yearLine = document.createElement("div");
      yearLine.style.position = "absolute";
      yearLine.style.top = "0";
      yearLine.style.bottom = "0";
      yearLine.style.width = "2px";
      yearLine.style.background = "#cfd8dc";
      yearLine.style.left = ((d - startAxis) / 86400000 * dayWidth) + "px";
      yearLine.style.zIndex = "0";
      timeline.insertBefore(yearLine, timeline.firstChild);
    }
  }

  const grouped = {};
  for (const ex of exhibitions) {
    if (!grouped[ex.location]) grouped[ex.location] = [];
    grouped[ex.location].push(ex);
  }

  let locationIndex = 0;
  const buffer = 20 * 86400000;

  for (const location in grouped) {
    const group = grouped[location];
    group.sort((a, b) => new Date(a.start) - new Date(b.start));
    const rows = [];

    group.forEach(ex => {
      const start = new Date(ex.start), end = new Date(ex.end);
      let rowIndex = rows.findIndex(r => new Date(r[r.length - 1].end).getTime() + buffer < start.getTime());
      if (rowIndex === -1) { rowIndex = rows.length; rows.push([]); }
      rows[rowIndex].push(ex);
      ex.row = rowIndex;
    });

    const locLabel = document.createElement("div");
    locLabel.className = "location-label";
    locLabel.style.top = (100 + locationIndex * 90) + "px";
    locLabel.textContent = location;
    timeline.appendChild(locLabel);

    group.forEach(ex => {
      const start = new Date(ex.start), end = new Date(ex.end);
      const startRef = new Date(baseYear - 1, 0, 1);
      const left = (start - startRef) / 86400000 * dayWidth;
      const width = (end - start) / 86400000 * dayWidth;
      const rowY = 70 + locationIndex * 90 + ex.row * 35;

      const div = document.createElement("div");
      div.className = "exhibition";
      div.style.left = left + "px";
      div.style.top = rowY + "px";
      div.style.width = width + "px";
      div.style.height = "6px";
      div.style.background = ex.color;
      div.dataset.id = ex.id;
      div.onclick = () => openModal(ex.id);

      const name = document.createElement("div");
      name.className = "name-label";
      name.textContent = ex.name;
      div.appendChild(name);

      const dates = document.createElement("div");
      dates.className = "date-row";
      const endYear = end.getFullYear();
      const sameYear = endYear === start.getFullYear();
      dates.innerHTML = `<span>${formatDateShort(start,false)}</span><span>${formatDateShort(end,!sameYear)}</span>`;
      div.appendChild(dates);

      timeline.appendChild(div);
    });

    locationIndex++;
  }

  const wrap = document.getElementById("timeline-wrapper");
  if (shouldCenter) {
    const yearStart = new Date(baseYear, 0, 1);
    const yearEnd = new Date(baseYear, 11, 31);
    const startRef = new Date(baseYear - 1, 0, 1);
    const janPos = (yearStart - startRef) / 86400000 * dayWidth;
    const decPos = (yearEnd - startRef) / 86400000 * dayWidth;
    const yearWidth = decPos - janPos;
    const visible = wrap.clientWidth;
    wrap.scrollLeft = (visible < yearWidth)
      ? janPos
      : janPos - (visible - yearWidth) / 2;
    shouldCenter = false;
  }

  timeline.style.height = (locationIndex * 100 + 120) + "px";
  initCustomScroll();
}

function formatDateShort(d, includeYear) {
  if (!d) return "";
  const dateObj = new Date(d);
  const m = ["jan","feb","mar","apr","maj","jun","jul","aug","sep","okt","nov","dec"];
  return dateObj.getDate() + " " + m[dateObj.getMonth()] + (includeYear ? " " + dateObj.getFullYear() : "");
}

function initCustomScroll() {
  const wrap = document.getElementById("timeline-wrapper");
  const thumb = document.getElementById("scrollThumb");
  const track = document.getElementById("scrollTrack");

  function updateThumb() {
    const ratio = wrap.scrollLeft / (wrap.scrollWidth - wrap.clientWidth);
    const maxLeft = track.clientWidth - thumb.offsetWidth;
    thumb.style.left = ratio * maxLeft + "px";
  }

  wrap.addEventListener("scroll", updateThumb);
  updateThumb();

  let dragging = false, startX = 0, startLeft = 0;
  thumb.addEventListener("mousedown", e => {
    dragging = true;
    startX = e.clientX;
    startLeft = parseFloat(thumb.style.left) || 0;
    document.body.style.userSelect = "none";
    thumb.style.transition = "none";
  });
  window.addEventListener("mousemove", e => {
    if (!dragging) return;
    const dx = e.clientX - startX;
    const maxLeft = track.clientWidth - thumb.offsetWidth;
    const newLeft = Math.min(Math.max(startLeft + dx, 0), maxLeft);
    thumb.style.left = newLeft + "px";
    const ratio = newLeft / maxLeft;
    wrap.scrollLeft = ratio * (wrap.scrollWidth - wrap.clientWidth);
  });
  window.addEventListener("mouseup", () => {
    if (dragging) {
      dragging = false;
      document.body.style.userSelect = "";
      thumb.style.transition = "left 0.05s ease-out";
    }
  });
}

/* === Start === */
window.onload = loadFromSheet;
</script>

</body>
</html>

